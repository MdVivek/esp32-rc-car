<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LOCAL joystick lib -->
  <script src="/nipplejs.min.js"></script>

  <style>
    /* ===== BASE LAYOUT ===== */
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #999;
    }

    .main-title {
      font-size: 2em;
      font-weight: bold;
      margin: 24px 0;
    }

    .panels-container {
      display: flex;
      flex: 1;
      width: 100%;
      justify-content: space-evenly;
      align-items: center;
    }

    /* ===== PANELS ===== */
    .left-panel,
    .right-panel {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== DRAGGABLE ===== */
    .draggable {
      position: absolute;
      cursor: grab;
      z-index: 5;
    }

    .draggable.editing {
      box-shadow: 0 0 0 3px #007bff;
      cursor: move;
    }

    /* ===== JOYSTICK ===== */
    #steering-joystick {
      width: 160px;
      height: 160px;
      background: #ddd;
      border-radius: 50%;
      touch-action: none;
    }

    /* ===== SPEED SLIDER ===== */
    #speed-slider {
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      width: 40px;
      height: 140px;
    }

    /* ===== BUTTONS ===== */
    button {
      border-radius: 24px;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
    }

    #brake-btn {
      height: 140px;
      background: linear-gradient(135deg, #36d1c4, #1e90ff);
    }

    /* ===== TOP UI ===== */
    #ws-status {
      position: absolute;
      top: 12px;
      left: 24px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border-radius: 10px;
    }

    .top-controls {
      position: absolute;
      top: 12px;
      right: 60px;
      display: flex;
      gap: 6px;
    }
  </style>
</head>

<body>
  <div id="ws-status">WS: connectingâ€¦</div>

  <div class="top-controls">
    <button id="edit-controls-btn">Edit</button>
    <button id="save-controls-btn" style="display:none;">Save</button>
    <button id="reset-controls-btn">Reset</button>
  </div>

  <div class="main-title">ESP32 RC Car Controller</div>

  <div class="panels-container">



    <!-- RIGHT: SPEED + BRAKE -->
    <div class="right-panel">
      <button id="brake-btn" class="draggable">Brake</button>

      <div class="draggable" id="speed-draggable">
        <label>Speed</label>
        <input type="range" id="speed-slider" min="-10" max="10" value="0">
        <div id="speed-value">0</div>
      </div>
    </div>

  </div>

  <script>
    /* ================= WS ================= */
    let ws;
    function connectWs() {
      ws = new WebSocket('ws://' + location.host + '/ws');
    }
    function sendJSON(o) {
      if (ws && ws.readyState === 1) ws.send(JSON.stringify(o));
    }
    window.onload = connectWs;

    /* ================= EDIT MODE ================= */
    let editMode = false;
    const editBtn = document.getElementById('edit-controls-btn');
    const saveBtn = document.getElementById('save-controls-btn');
    const resetBtn = document.getElementById('reset-controls-btn');

    function makeDraggable(el, key) {
      let dragging = false, ox = 0, oy = 0;

      el.addEventListener('mousedown', e => {
        if (!editMode) return;
        dragging = true;
        el.classList.add('editing');
        ox = e.clientX - el.offsetLeft;
        oy = e.clientY - el.offsetTop;
      });

      document.addEventListener('mousemove', e => {
        if (!dragging) return;
        el.style.left = (e.clientX - ox) + 'px';
        el.style.top = (e.clientY - oy) + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        el.classList.remove('editing');
        localStorage.setItem(key, JSON.stringify({
          x: el.offsetLeft, y: el.offsetTop
        }));
      });

      const saved = localStorage.getItem(key);
      if (saved) {
        const p = JSON.parse(saved);
        el.style.left = p.x + 'px';
        el.style.top = p.y + 'px';
      }
    }


    makeDraggable(document.getElementById('speed-draggable'), 'speedPos');
    makeDraggable(document.getElementById('brake-btn'), 'brakePos');

    editBtn.onclick = () => {
      editMode = true;
      editBtn.style.display = 'none';
      saveBtn.style.display = '';
    };

    saveBtn.onclick = () => {
      editMode = false;
      editBtn.style.display = '';
      saveBtn.style.display = 'none';
    };

    resetBtn.onclick = () => {
      localStorage.clear();
      location.reload();
    };

    /* ================= SPEED ================= */
    let speed = 0;
    const speedSlider = document.getElementById('speed-slider');
    const speedVal = document.getElementById('speed-value');

    speedSlider.oninput = () => {
      speed = parseInt(speedSlider.value);
      speedVal.textContent = speed;
      sendJSON({ cmd: 'set', param: 'speed_pct', value: speed });
    };


  </script>
</body>

</html>